services:
  mongo1:
    image: mongo:7
    container_name: mongo1
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all", "--port", "27017", "--setParameter", "diagnosticDataCollectionEnabled=false"]
    ports:
      - "27017:27017"
    volumes:
      - mongo1_data:/data/db
    restart: unless-stopped

  mongo2:
    image: mongo:7
    container_name: mongo2
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all", "--port", "27017", "--setParameter", "diagnosticDataCollectionEnabled=false"]
    volumes:
      - mongo2_data:/data/db
    restart: unless-stopped

  mongo3:
    image: mongo:7
    container_name: mongo3
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all", "--port", "27017", "--setParameter", "diagnosticDataCollectionEnabled=false"]
    volumes:
      - mongo3_data:/data/db
    restart: unless-stopped

  # One-shot init container (Windows-safe): runs a mounted shell script.
  mongors-init:
    image: mongo:7
    container_name: mongors-init
    depends_on:
      - mongo1
      - mongo2
      - mongo3
    volumes:
      - ./mongo-init:/mongo-init:ro
    entrypoint: ["bash", "/mongo-init/init.sh"]
    restart: "no"

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.14.3
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    restart: unless-stopped

  # Redpanda (Kafka API compatible) for streaming
  redpanda:
    image: redpandadata/redpanda:v24.2.13
    container_name: redpanda
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp
      - "1"
      - --memory
      - "1G"
      - --reserve-memory
      - "0M"
      - --node-id
      - "0"
      - --check=false
      - --kafka-addr
      - PLAINTEXT://0.0.0.0:9092
      - --advertise-kafka-addr
      - PLAINTEXT://redpanda:9092
      - --pandaproxy-addr
      - 0.0.0.0:8082
      - --advertise-pandaproxy-addr
      - redpanda:8082
    ports:
      - "9092:9092"
      - "9644:9644"
    restart: unless-stopped

  # Create topics (one-shot).
  kafka-init:
    image: redpandadata/redpanda:v24.2.13
    container_name: kafka-init
    depends_on:
      - redpanda
    entrypoint: ["bash", "-lc"]
    command: |
      set -e
      echo "[kafka-init] waiting for redpanda..."
      until rpk cluster info -X brokers=redpanda:9092 >/dev/null 2>&1; do
        sleep 2
      done
      echo "[kafka-init] creating topics (idempotent)..."
      rpk topic create transactions alerts -X brokers=redpanda:9092 || true
      echo "[kafka-init] done"
    restart: "no"

  api1:
    build: ./api
    container_name: api1
    environment:
      - MONGO_URI=mongodb://mongo1:27017,mongo2:27017,mongo3:27017/?replicaSet=rs0
      - DB_NAME=finance
      - ES_URL=http://elasticsearch:9200
      - KAFKA_BOOTSTRAP=redpanda:9092
      - TRANSACTIONS_TOPIC=transactions
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - mongors-init
      - elasticsearch
      - kafka-init
      - redis
    restart: unless-stopped

  api2:
    build: ./api
    container_name: api2
    environment:
      - MONGO_URI=mongodb://mongo1:27017,mongo2:27017,mongo3:27017/?replicaSet=rs0
      - DB_NAME=finance
      - ES_URL=http://elasticsearch:9200
      - KAFKA_BOOTSTRAP=redpanda:9092
      - TRANSACTIONS_TOPIC=transactions
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - mongors-init
      - elasticsearch
      - kafka-init
      - redis
    restart: unless-stopped

  alert-service:
    build: ./alert-service
    container_name: alert-service
    environment:
      - MONGO_URI=mongodb://mongo1:27017,mongo2:27017,mongo3:27017/?replicaSet=rs0
      - DB_NAME=finance
      - KAFKA_BOOTSTRAP=redpanda:9092
      - TRANSACTIONS_TOPIC=transactions
      - ALERTS_TOPIC=alerts
      - REDIS_URL=redis://redis:6379/0
      - ALERT_STD_MULTIPLIER=2.5
      - MIN_BASELINE_COUNT=5
    depends_on:
      - mongors-init
      - kafka-init
      - redis
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "8080:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api1
      - api2
    restart: unless-stopped

volumes:
  mongo1_data:
  mongo2_data:
  mongo3_data:
  es_data:
